-- 전자결재
-- 테이블 생성
-- 결석 신청 테이블 생성
CREATE TABLE APP_FORM(
	FORM_SEQ NUMBER NOT NULL,
	APP_DATE DATE NOT NULL,
	STUDENT_ID VARCHAR2(12) NOT NULL,
	RECIPIENT_ID VARCHAR2(12) NOT NULL,
	COURSECODE VARCHAR2(10) NOT NULL,
	REASON VARCHAR2(50) NOT NULL,
	START_DATE DATE NOT NULL,
	ABSENT_DAYS NUMBER NOT NULL, -- START_DATE + ABSENT_DAYS - 1 = 마지막 결석일
	FILENAME VARCHAR2(500),
	NEWFILENAME VARCHAR2(500),
	CONSTRAINT APP_FORM_PK PRIMARY KEY(FORM_SEQ)
);

-- 신청서 SEQ 생성
CREATE SEQUENCE APP_FORM_SEQ INCREMENT BY 1 START WITH 1;



-- 승인 여부 테이블 
CREATE TABLE IS_APPROVE(
	FORM_SEQ NUMBER NOT NULL,
	STM CHAR DEFAULT 'N' NOT NULL,
	CONSTRAINT IS_APPROVE_PK PRIMARY KEY(FORM_SEQ)
);

-- 사인 테이블 생성
CREATE TABLE SIGNATURE(
	SIGNATURE_ID VARCHAR2(12) NOT NULL,
	USECHECK CHAR NOT NULL,
	FILENAME VARCHAR2(500) NOT NULL,
	NEWFILENAME VARCHAR2(500) NOT NULL,
	CONSTRAINT SIGNATURE_PK PRIMARY KEY(SIGNATURE_ID)
);

-- 반려 사유 테이블 생성
CREATE TABLE UNAPPROVED(
	FORM_SEQ NUMBER NOT NULL,
	REASON VARCHAR2(100),
	CONSTRAINT UNAPPROVED_PK PRIMARY KEY(FORM_ID)
);




-- 조회
-- 게시판에서 학생이 자신의 신청내역 조회(처리중) STM = 'Y'승인됨, 'N'처리중, 'R'반려됨, ID = '학생 자신의 ID'
SELECT A.FORM_SEQ
	, A.APP_DATE
	, A.COURSECODE
	, A.START_DATE
	, IS_APPROVE.STM
	, (SELECT COURSENAME
		FROM COURSE
		WHERE COURSECODE = A.COURSECODE) AS COURSENAME
FROM APP_FORM A
JOIN IS_APPROVE ON A.FORM_SEQ = IS_APPROVE.FORM_SEQ
WHERE IS_APPROVE.STM = 'R' AND A.STUDENT_ID = '01082081952';



-- 클릭해서 각 신청을 상세조회(승인, 처리중)
SELECT APP_DATE, A.REASON, START_DATE, ABSENT_DAYS, FILENAME, NEWFILENAME, STM
FROM APP_FORM A JOIN IS_APPROVE I ON A.FORM_SEQ = I.FORM_SEQ
WHERE A.FORM_SEQ = '3';
-- 승인인 경우 수신인의 사인 이미지를 가져옴
SELECT S.NEWFILENAME
FROM SIGNATURE S
JOIN APP_FORM A ON A.RECIPIENT_ID = S.SIGNATURE_ID
JOIN IS_APPROVE I ON I.FORM_SEQ = A.FORM_SEQ
WHERE S.SIGNATURE_ID = '01011111111' AND A.FORM_SEQ = '2' AND I.STM = 'Y';

-- 클릭해서 각 신청을 상세조회(반려시)
SELECT A.FORM_SEQ, APP_DATE, A.REASON, START_DATE, ABSENT_DAYS, FILENAME, NEWFILENAME, STM, U.REASON
FROM APP_FORM A JOIN IS_APPROVE I ON A.FORM_SEQ = I.FORM_SEQ
				JOIN UNAPPROVED U ON I.FORM_SEQ = U.FORM_SEQ
WHERE A.FORM_SEQ = '1';


-- 수신인 자신에게 온 신청서 리스트
--SELECT * FROM APP_FORM
--WHERE (RECIPIENT_ID, COURSECODE) IN (SELECT RECIPIENT_ID, COURSECODE FROM TEACHER JOIN COURSE USING(COURSECODE));

-- 강사 자신에게 온 신청서 리스트
-- 학생 이름, 신청일, 승인 여부 (자신에게 온 것만 보여야함), 신청서 SEQ. I.STM = 'Y' 상태에 따라 다름
SELECT A.APP_DATE,
	   I.STM,
	   S.NAME,
	   A.FORM_SEQ
FROM APP_FORM A JOIN IS_APPROVE I ON A.FORM_SEQ = I.FORM_SEQ
			    JOIN STUDENT S ON A.STUDENT_ID = S.ID 
			    , TEACHER T
WHERE A.COURSECODE = T.COURSECODE 
AND T.ID = '01000000000' AND I.STM = 'Y';

-- 관리자가 자신에게 온 신청서만 상태별로 봄
SELECT A.APP_DATE,
	   I.STM,
	   S.NAME,
	   A.FORM_SEQ
FROM APP_FORM A JOIN IS_APPROVE I ON A.FORM_SEQ = I.FORM_SEQ
				JOIN STUDENT S ON A.STUDENT_ID = S.ID
WHERE A.RECIPIENT_ID = '01011111111' AND I.STM = 'Y';


-- 클릭해서 각 신청을 상세조회(승인, 처리중)
SELECT APP_DATE, A.REASON, START_DATE, ABSENT_DAYS, FILENAME, NEWFILENAME, STM
FROM APP_FORM A JOIN IS_APPROVE I ON A.FORM_SEQ = I.FORM_SEQ
WHERE A.FORM_SEQ = '3';

-- 클릭해서 각 신청을 상세조회(반려시)
SELECT A.FORM_SEQ, APP_DATE, A.REASON, START_DATE, ABSENT_DAYS, FILENAME, NEWFILENAME, STM, U.REASON
FROM APP_FORM A JOIN IS_APPROVE I ON A.FORM_SEQ = I.FORM_SEQ
				JOIN UNAPPROVED U ON I.FORM_SEQ = U.FORM_SEQ
WHERE A.FORM_SEQ = '1';


-- 학생이 신청
INSERT INTO APP_FORM
(FORM_SEQ, APP_DATE, STUDENT_ID, RECIPIENT_ID,
COURSECODE, REASON, START_DATE, ABSENT_DAYS,
FILENAME, NEWFILENAME)
VALUES(APP_FORM_SEQ.NEXTVAL, SYSDATE, '01082081952', '01011111111', 'CODE002', '감기로 출석이 어려움', '20190503', 3, '진단서', '01082081952_첨부');
-- 방금 생성한 신청서의 SEQ를 찾아옴
SELECT MAX(FORM_SEQ) FROM APP_FORM;
-- 찾은 SEQ로 신청서에 대한 상태 테이블이 생성
INSERT INTO IS_APPROVE(FORM_SEQ, STM)
VALUES(5, 'N');


-- 강사 및 관리자가 승인을 함
UPDATE IS_APPROVE
SET STM = 'Y'
WHERE FORM_SEQ = '5';
-- 


-- 강사 및 관리자가 미승인(반려) 버튼을 누름
-- 새로운 TEXTAREA 등 생성, 내용 기입
INSERT INTO UNAPPROVED
VALUES(5, '싫음');
-- 동시에 승인 여부 수정
UPDATE IS_APPROVE
SET STM = 'R'
WHERE FORM_SEQ = 5;


-- 강사나 관리자가 사인 이미지를 동록
INSERT INTO SIGNATURE(SIGNATURE_ID, USECHECK, FILENAME, NEWFILENAME)
VALUES('01010101010', 'Y', '사인', '01010101010_SIGNATURE');

SELECT A.FORM_SEQ, T.ID 
FROM APP_FORM A
	, TEACHER T
WHERE A.COURSECODE(+) = T.COURSECODE


